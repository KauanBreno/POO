{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-md-11">
      <!-- Cabeçalho -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Lista de Clientes</h1>
        <div class="d-flex">
          <a href="{% url 'register' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Novo Cliente
          </a>
          <form method="get" class="d-flex" role="search">
            <input
              class="form-control mx-2"
              type="search"
              placeholder="Buscar por nome, razão social ou CNPJ..."
              name="q"
              value="{{ request.GET.q|default:'' }}">
            <button class="btn btn-outline-primary" type="submit">Buscar</button>
          </form>
        </div>
      </div>

      <!-- Card da Tabela -->
      <div class="card shadow-sm">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-dark">
                <tr>
                  <th>Razão Social</th>
                  <th>Nome Fantasia</th>
                  <th>E-mail</th>
                  <th>CNPJ</th>
                  <th>Cidade / UF</th>
                </tr>
              </thead>
              <tbody id="clientes-tbody">
                {% for cliente in clientes %}
                <tr onclick="window.location='{% url 'cliente' cliente.pk %}'" style="cursor: pointer;" class="align-middle">
                  <td class="text-truncate" style="max-width: 250px;" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ cliente.razao_social }}">
                    <strong>{{ cliente.razao_social }}</strong>
                  </td>
                  <td class="text-truncate" style="max-width: 200px;" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ cliente.nome_fantasia }}">
                    {% if cliente.nome_fantasia %}
                      {{ cliente.nome_fantasia }}
                    {% else %}
                      <span class="text-muted fst-italic">Não informado</span>
                    {% endif %}
                  </td>
                  <td class="text-truncate" style="max-width: 180px;" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ cliente.contatos.email }}">
                    {% if cliente.contatos.email %}
                      <span class="text-primary">{{ cliente.contatos.email }}</span>
                    {% else %}
                      <span class="text-muted fst-italic">Não informado</span>
                    {% endif %}
                  </td>
                  <td class="cnpj text-nowrap">{{ cliente.cnpj }}</td>
                  <td class="text-truncate" style="max-width: 150px;" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ cliente.endereco.municipio }} - {{ cliente.endereco.uf }}">
                    {% if cliente.endereco %}
                      {{ cliente.endereco.municipio }} / {{ cliente.endereco.uf }}
                    {% else %}
                      <span class="text-muted fst-italic">Sem endereço</span>
                    {% endif %}
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="5" class="text-center py-5">
                    <div class="text-muted">
                      <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                      <p class="mt-3 mb-1">Nenhum cliente cadastrado</p>
                      <small>Clique em "Novo Cliente" para começar</small>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Informação de Total -->
      {% if clientes %}
      <div class="mt-3 text-muted">
        <small>Total: {{ clientes|length }} cliente{{ clientes|length|pluralize }}</small>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    function cnpjMask(cnpj) {
      let value = cnpj.replace(/\D/g, '');
      value = value.replace(/^(\d{2})(\d)/, '$1.$2');
      value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
      value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
      value = value.replace(/(\d{4})(\d)/, '$1-$2');
      return value.slice(0, 18);
    }

    document.querySelectorAll('.cnpj').forEach(td => {
      td.textContent = cnpjMask(td.textContent);
    });

    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    const tooltipList = [...tooltipTriggerList].map(el => new bootstrap.Tooltip(el, {
      delay: { "show": 700, "hide": 0 } // 1000ms = 1 segundo
    }));


    const tbody = document.getElementById('clientes-tbody');
    const searchInput = document.querySelector('input[name="q"]');

    function atualizarTabela(clientes) {
      tbody.innerHTML = ''; // limpa
      if (clientes.length === 0) {
        tbody.innerHTML = `<tr>
          <td colspan="5" class="text-center py-5 text-muted">Nenhum cliente encontrado</td>
        </tr>`;
        return;
      }
      clientes.forEach(c => {
        const tr = document.createElement('tr');
        tr.classList.add('align-middle');
        tr.style.cursor = 'pointer';
        tr.onclick = () => window.location = `clientes/${c.id}/`;
        tr.innerHTML = `
          <td class="text-truncate" style="max-width: 250px;" data-bs-toggle="tooltip" data-bs-placement="top" title="${c.razao_social}">
            <strong>${c.razao_social}</strong>
          </td>
          <td class="text-truncate" style="max-width: 200px;" data-bs-toggle="tooltip" data-bs-placement="top" title="${c.nome_fantasia || ''}">
            ${c.nome_fantasia || '<span class="text-muted fst-italic">Não informado</span>'}
          </td>
          <td class="text-truncate" style="min-width: 180px; max-width: 180px;" data-bs-toggle="tooltip" data-bs-placement="top" title="${c.email || ''}">
            ${c.email ? `<span class="text-primary">${c.email}</span>` : '<span class="text-muted fst-italic">Não informado</span>'}
          </td>
          <td class="cnpj text-nowrap">${c.cnpj}</td>
          <td class="text-truncate" style="max-width: 150px;" data-bs-toggle="tooltip" data-bs-placement="top" title="${c.cidade_uf || ''}">
            ${c.cidade_uf || '<span class="text-muted fst-italic">Sem endereço</span>'}
          </td>
        `;
        tbody.appendChild(tr);
        document.querySelectorAll('.cnpj').forEach(td => {
          td.textContent = cnpjMask(td.textContent);
      });
      });
    }

    function buscarClientes() {
      const query = searchInput.value.trim();
      fetch(`search-clientes/?q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => atualizarTabela(data.clientes))
        .catch(err => console.error('Erro na busca:', err));
    }

    // dispara ao digitar (tecla solta)
    searchInput.addEventListener('keyup', function(e) {
      buscarClientes();
    });

    // dispara se o usuário clicar no botão Buscar
    const searchForm = searchInput.closest('form');
    searchForm.addEventListener('submit', function(e) {
      e.preventDefault(); // evita recarregar
      buscarClientes();
    });
  });
</script>
{% endblock %}
